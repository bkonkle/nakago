"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[187],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),s=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=s(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),u=s(n),h=r,m=u["".concat(l,".").concat(h)]||u[h]||d[h]||i;return n?a.createElement(m,o(o({ref:t},c),{},{components:n})):a.createElement(m,o({ref:t},c))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=h;var p={};for(var l in t)hasOwnProperty.call(t,l)&&(p[l]=t[l]);p.originalType=e,p[u]="string"==typeof e?e:r,o[1]=p;for(var s=2;s<i;s++)o[s]=n[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},2684:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>p,toc:()=>s});var a=n(7462),r=(n(7294),n(3905));const i={sidebar_position:3},o="Axum HTTP Applications",p={unversionedId:"features/axum-http",id:"features/axum-http",title:"Axum HTTP Applications",description:"The nakago-axum crate defines AxumApplication, which wraps Application and provides a way to Run an HTTP service.",source:"@site/docs/features/axum-http.md",sourceDirName:"features",slug:"/features/axum-http",permalink:"/nakago/docs/features/axum-http",draft:!1,editUrl:"https://github.com/bkonkle/nakago/tree/main/website/docs/features/axum-http.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"documentationSidebar",previous:{title:"Application Lifecycle",permalink:"/nakago/docs/features/application"},next:{title:"SeaORM",permalink:"/nakago/docs/features/sea-orm"}},l={},s=[{value:"Application Lifecycle",id:"application-lifecycle",level:2},{value:"Init",id:"init",level:3},{value:"Startup",id:"startup",level:3},{value:"Starting the Application",id:"starting-the-application",level:2},{value:"Integration Testing",id:"integration-testing",level:2},{value:"CI Integration Testing",id:"ci-integration-testing",level:3}],c={toc:s},u="wrapper";function d(e){let{components:t,...n}=e;return(0,r.kt)(u,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"axum-http-applications"},"Axum HTTP Applications"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"nakago-axum")," crate defines ",(0,r.kt)("inlineCode",{parentName:"p"},"AxumApplication"),", which wraps ",(0,r.kt)("inlineCode",{parentName:"p"},"Application")," and provides a way to Run an HTTP service."),(0,r.kt)("h2",{id:"application-lifecycle"},"Application Lifecycle"),(0,r.kt)("h3",{id:"init"},"Init"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"Init")," Hook for an Axum Application automatically adds the ",(0,r.kt)("inlineCode",{parentName:"p"},"HttpConfig")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"AuthConfig")," Config Loaders before the user-provided hook is invoked and the Config is generated."),(0,r.kt)("h3",{id:"startup"},"Startup"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"Startup")," Hook for an Axum Application uses the State with the provided Router, allowing the flow of the application to proceed through the Axum request handlers."),(0,r.kt)("h2",{id:"starting-the-application"},"Starting the Application"),(0,r.kt)("p",null,"To start your application, pass in your top-level Config type and create an instance. Attach Hooks in the order that they should be executed:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},"let mut app = AxumApplication::<AppConfig>::default();\napp.on(&EventType::Init, InitDomains::default());\napp.on(&EventType::Init, InitApp::default());\napp.on(&EventType::Startup, InitAuthz::default());\n")),(0,r.kt)("p",null,"Then, use ",(0,r.kt)("inlineCode",{parentName:"p"},"run")," to start the application and return the connection details."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'let server = app.run::<AppState>(args.config_path).await?;\nlet addr = server.local_addr();\n\ninfo!("Started on port: {port}", port = addr.port());\n\nserver.await?;\n')),(0,r.kt)("h2",{id:"integration-testing"},"Integration Testing"),(0,r.kt)("p",null,"Testing is handled by initializing your application server in a way similar to Production, and using a Lazy OnceCell to hold an HttpConnector you can use to make requests to the application."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},"static HTTP_CLIENT: Lazy<Client<HttpsConnector<HttpConnector>>> = Lazy::new(http_client);\n\n/// Creates an http/https client via Hyper\npub fn http_client() -> Client<HttpsConnector<HttpConnector>> {\n    Client::builder().build::<_, Body>(HttpsConnector::new())\n}\n")),(0,r.kt)("p",null,"This can then be used to make requests to the running application instance for integration testing:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},"let mut req = Request::builder().method(Method::POST).uri(&self.url);\n\nlet resp = http_client.request(req).await?;\n")),(0,r.kt)("p",null,"See the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/bkonkle/nakago/tree/feature/nakago-sea-orm/examples/async-graphql/tests"},"Async-GraphQL Example's integration tests")," for examples of how to use this pattern. This will evolve as more pieces are moved into the framework itself over time."),(0,r.kt)("h3",{id:"ci-integration-testing"},"CI Integration Testing"),(0,r.kt)("p",null,"This strategy can be used for integration testing in the CI service of your choice based on a Docker Compose formation of shallow dependencies. This allows you to set up things like LocalStack or Postgers within your CI Docker environment and run integration tests against them without needing to use deployed resources. Branch-specific PR's are easy to run tests for in isolation."),(0,r.kt)("p",null,"Stay tuned for more details on how to set up this approach in your CI environment."))}d.isMDXComponent=!0}}]);