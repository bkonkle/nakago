"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[554],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>m});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var u=a.createContext({}),p=function(e){var t=a.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},s=function(e){var t=p(e.components);return a.createElement(u.Provider,{value:t},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,u=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),d=p(n),h=o,m=d["".concat(u,".").concat(h)]||d[h]||c[h]||r;return n?a.createElement(m,i(i({ref:t},s),{},{components:n})):a.createElement(m,i({ref:t},s))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=h;var l={};for(var u in t)hasOwnProperty.call(t,u)&&(l[u]=t[u]);l.originalType=e,l[d]="string"==typeof e?e:o,i[1]=l;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},6351:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>i,default:()=>c,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var a=n(7462),o=(n(7294),n(3905));const r={sidebar_position:2},i="Tutorial",l={unversionedId:"tutorial",id:"tutorial",title:"Tutorial",description:"This tutorial will walk you through the basics of using Nakago to build a simple HTTP service. It will use Axum to provide HTTP routes and will decode the user's JWT token and verify their identity via a separate OAuth2 provider, such as Auth0 or Okta or your own self-hosted service.",source:"@site/docs/tutorial.md",sourceDirName:".",slug:"/tutorial",permalink:"/docs/tutorial",draft:!1,editUrl:"https://github.com/bkonkle/nakago/tree/main/website/docs/tutorial.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"documentationSidebar",previous:{title:"Welcome to Nakago",permalink:"/docs/intro"},next:{title:"Features",permalink:"/docs/category/features"}},u={},p=[{value:"Cargo-Generate Template",id:"cargo-generate-template",level:2},{value:"Setup",id:"setup",level:2},{value:"Authentication",id:"authentication",level:2},{value:"AuthConfig",id:"authconfig",level:3},{value:"Axum State",id:"axum-state",level:3},{value:"Axum Route",id:"axum-route",level:3},{value:"Running the App",id:"running-the-app",level:3},{value:"Integration Testing",id:"integration-testing",level:2}],s={toc:p},d="wrapper";function c(e){let{components:t,...n}=e;return(0,o.kt)(d,(0,a.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"tutorial"},"Tutorial"),(0,o.kt)("p",null,"This tutorial will walk you through the basics of using Nakago to build a simple HTTP service. It will use Axum to provide HTTP routes and will decode the user's JWT token and verify their identity via a separate OAuth2 provider, such as Auth0 or Okta or your own self-hosted service."),(0,o.kt)("h2",{id:"cargo-generate-template"},"Cargo-Generate Template"),(0,o.kt)("p",null,"First install ",(0,o.kt)("inlineCode",{parentName:"p"},"cargo-generate"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"cargo install cargo-generate\n")),(0,o.kt)("p",null,"Then generate a new project with this template:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"cargo generate bkonkle/nakago-simple-template\n")),(0,o.kt)("p",null,"You'll see a folder structure like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-text"},"simple/\n\u251c\u2500 .cargo/ -- Clippy config\n\u251c\u2500 .github/ -- Github Actions\n\u251c\u2500 config/ -- Config files for different environments\n\u251c\u2500 src/\n\u2502  \u251c\u2500 http/ -- Axum HTTP routes\n\u2502  \u2502  \u251c\u2500 handlers.rs\n\u2502  \u2502  \u251c\u2500 mod.rs\n\u2502  \u2502  \u251c\u2500 routes.rs\n\u2502  \u2502  \u2514\u2500 state.rs\n\u2502  \u251c\u2500 config.rs -- Your app's custom Config struct\n\u2502  \u251c\u2500 init.rs -- App initialization\n\u2502  \u251c\u2500 lib.rs\n\u2502  \u2514\u2500 main.rs -- Main entry point\n\u251c\u2500 Cargo.toml\n\u251c\u2500 Makefile.toml\n\u251c\u2500 README.md\n\u2514\u2500 // ...\n")),(0,o.kt)("p",null,"This includes a simple ",(0,o.kt)("inlineCode",{parentName:"p"},"AppConfig")," struct with an embedded ",(0,o.kt)("inlineCode",{parentName:"p"},"HttpConfig")," provided by the ",(0,o.kt)("inlineCode",{parentName:"p"},"nakago-axum")," library. You can add your own configuration fields to this struct and they'll be populated by the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.rs/figment/latest/figment/"},"figment")," crate."),(0,o.kt)("p",null,"It includes a barebones ",(0,o.kt)("inlineCode",{parentName:"p"},"init::app()")," function that will load your configuration and initialize your dependencies. You can add your own dependencies to this function and they'll be available when you build your Axum route state."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"main.rs")," uses the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.rs/pico-args/0.5.0/pico_args/"},"pico-args")," to parse a simple command-line argument to specify an alternate config path, which is useful for many deployment scenarios that dynamically map a config file to a certain mount point within a container filesystem."),(0,o.kt)("p",null,"In the ",(0,o.kt)("inlineCode",{parentName:"p"},"http/")," folder, you'll find an empty AppState with a dependency injection Provider that you can fill in with your own dependencies. The router maps a simple ",(0,o.kt)("inlineCode",{parentName:"p"},"GET /health")," route to a handler that returns a JSON response with a success message."),(0,o.kt)("p",null,"You now have a simple foundation to build on. Let's add some more functionality!"),(0,o.kt)("h2",{id:"setup"},"Setup"),(0,o.kt)("p",null,"Follow the Installation instructions in the ",(0,o.kt)("inlineCode",{parentName:"p"},"README.md")," to prepare your new local environment."),(0,o.kt)("h2",{id:"authentication"},"Authentication"),(0,o.kt)("p",null,"One of the first things you'll probably want to add to your application is authentication, which establishes the user's identity. This is separate and distinct from authorization, which determines what the user is allowed to do."),(0,o.kt)("p",null,"The only currently supported method of authentication is through JWT with JWKS keys. The ",(0,o.kt)("inlineCode",{parentName:"p"},"nakago-axum")," library provides a request extension for for Axum that will use ",(0,o.kt)("a",{parentName:"p",href:"https://docs.rs/biscuit/0.6.0/biscuit/"},"biscuit")," to decode a JWT from the ",(0,o.kt)("inlineCode",{parentName:"p"},"Authorization")," header, validate it with a JWKS key from the ",(0,o.kt)("inlineCode",{parentName:"p"},"/.well-known/jwks.json")," path on the auth url, and then return the value of the ",(0,o.kt)("inlineCode",{parentName:"p"},"sub")," claim from the payload."),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Configurable claims and other authentication methods will be added in the future.")),(0,o.kt)("h3",{id:"authconfig"},"AuthConfig"),(0,o.kt)("p",null,"In your ",(0,o.kt)("inlineCode",{parentName:"p"},"config.rs")," file, add a new property to the ",(0,o.kt)("inlineCode",{parentName:"p"},"AppConfig")," struct:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"use nakago_axum::auth::config::AuthConfig,\n\n/// Server Config\n#[derive(Default, Debug, Serialize, Deserialize, Clone, FromRef)]\npub struct AppConfig {\n    /// HTTP config\n    pub http: HttpConfig,\n\n    /// HTTP Auth Config\n    pub auth: AuthConfig,\n}\n")),(0,o.kt)("p",null,"This ",(0,o.kt)("inlineCode",{parentName:"p"},"AuthConfig")," is automatically loaded as part of the default config loaders in the ",(0,o.kt)("inlineCode",{parentName:"p"},"nakago-axum")," crate, so this line in the ",(0,o.kt)("inlineCode",{parentName:"p"},"init.rs")," ensures that it is populated from environment variables or the currently chosen config file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"// Config\n\napp.on(\n    &EventType::Load,\n    AddConfigLoaders::new(default_http_config_loaders()),\n);\n")),(0,o.kt)("p",null,"Next, add the following to your ",(0,o.kt)("inlineCode",{parentName:"p"},"config/default.toml")," file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-toml"},'[auth]\nurl = "https://simple-dev.oauth-service.com"\naudience = "localhost"\n\n[auth.client]\n')),(0,o.kt)("p",null,"Then, add a hint to your ",(0,o.kt)("inlineCode",{parentName:"p"},"config/local.toml.example")," so that new developers know they need to reach out to you for real values when they create their own ",(0,o.kt)("inlineCode",{parentName:"p"},"config/local.toml")," file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-toml"},'[auth.client]\nid = "client_id"\nsecret = "client_secret"\n')),(0,o.kt)("p",null,"Add the real details to your own ",(0,o.kt)("inlineCode",{parentName:"p"},"config/local.toml")," file, which should be excluded from git via the ",(0,o.kt)("inlineCode",{parentName:"p"},".gitignore")," file."),(0,o.kt)("h3",{id:"axum-state"},"Axum State"),(0,o.kt)("p",null,"Before you can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"Subject")," request extension with your Axum routes, you'll need to add the ",(0,o.kt)("inlineCode",{parentName:"p"},"AuthState")," to your ",(0,o.kt)("inlineCode",{parentName:"p"},"AppState")," in your ",(0,o.kt)("inlineCode",{parentName:"p"},"http/state.rs")," file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"use nakago_axum::auth::authenticate::AuthState;\n\n/// The top-level Application State\n#[derive(Clone, FromRef)]\npub struct AppState {\n    auth: AuthState,\n}\n")),(0,o.kt)("p",null,"In your ",(0,o.kt)("inlineCode",{parentName:"p"},"init.rs")," file, you'll want to add the use ",(0,o.kt)("inlineCode",{parentName:"p"},"ProvideJwks")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"ProvideAuthState")," to provide the AuthState that the custom ",(0,o.kt)("inlineCode",{parentName:"p"},"ProvideAppState")," provider unique to your app will use to populate that property."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"// Dependencies\n\napp.provide(&JWKS, ProvideJwks::default().with_config_tag(&CONFIG)).await?;\napp.provide(&AUTH_STATE, ProvideAuthState::default()).await?;\n")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},".with_config_tag(&CONFIG)")," provides the custom Tag for your ",(0,o.kt)("inlineCode",{parentName:"p"},"AppConfig"),", which will be unique to your app."),(0,o.kt)("p",null,"Then you can update the ",(0,o.kt)("inlineCode",{parentName:"p"},"ProvideAppState")," provider in ",(0,o.kt)("inlineCode",{parentName:"p"},"http/state.rs")," to retrieve the ",(0,o.kt)("inlineCode",{parentName:"p"},"AuthState")," you provided earlier and use it when creating the ",(0,o.kt)("inlineCode",{parentName:"p"},"AppState"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"#[Provider]\n#[async_trait]\nimpl Provider<AppState> for ProvideAppState {\n    async fn provide(self: Arc<Self>, i: Inject) -> InjectResult<Arc<AppState>> {\n        let auth = i.get(&AUTH_STATE).await?;\n\n        Ok(Arc::new(AppState {\n            auth: (*auth).clone(),\n        }))\n    }\n}\n")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"(*auth).clone()")," is because the `AuthState`` initially comes wrapped in an Arc, and this easily clones it out of the Arc."),(0,o.kt)("p",null,"You'll probably also want to add a note to the docstring for your ",(0,o.kt)("inlineCode",{parentName:"p"},"ProvideAppState")," provider so that you can see at a glance that this is a dependency your AppState requires."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"/// **Depends on:**\n///   - `Tag(AuthState)`\n")),(0,o.kt)("h3",{id:"axum-route"},"Axum Route"),(0,o.kt)("p",null,"You can now add a quick handler that allows a user to view their own username when logged in."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},'// Get Username\n// ------------\n\n/// A Username Response\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct UsernameResponse {\n    /// The Status code\n    code: usize,\n\n    /// The username, or "(anonymous)"\n    username: String,\n}\n\n/// Handle Get Username requests\npub async fn get_username_handler(sub: Subject) -> Json<UsernameResponse> {\n    let username = if let Subject(Some(username)) = sub {\n        username.clone()\n    } else {\n        "(anonymous)".to_string()\n    };\n\n    Json(UsernameResponse {\n        code: 200,\n        username,\n    })\n}\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"Subject")," extension uses the AuthState to decode the JWT and return the ",(0,o.kt)("inlineCode",{parentName:"p"},"sub")," claim from the payload. If the user is not logged in, the ",(0,o.kt)("inlineCode",{parentName:"p"},"Subject")," will contain a ",(0,o.kt)("inlineCode",{parentName:"p"},"None"),"."),(0,o.kt)("p",null,"Now add a route that uses the handler to ",(0,o.kt)("inlineCode",{parentName:"p"},"http/routes.rs"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},'/// Initialize the User route\npub fn new_user_route(_: Inject) -> Route<AppState> {\n    Route::new("/", Router::new().route("/username", get(get_username_handler)))\n}\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"Inject")," container is there if you need it, but most things will be provided as part of the ",(0,o.kt)("inlineCode",{parentName:"p"},"AppState")," so you can ignore it."),(0,o.kt)("p",null,"Finally, in your ",(0,o.kt)("inlineCode",{parentName:"p"},"init.rs")," add a new ",(0,o.kt)("inlineCode",{parentName:"p"},"InitRoute")," hook to your app:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"// Routes\n\napp.on(&EventType::Init, InitRoute::new(new_health_route));\napp.on(&EventType::Init, InitRoute::new(new_user_route)); // <-- the new route\n")),(0,o.kt)("h3",{id:"running-the-app"},"Running the App"),(0,o.kt)("p",null,"At this point, you can run your app and see the ",(0,o.kt)("inlineCode",{parentName:"p"},"(anonymous)")," response at the ",(0,o.kt)("inlineCode",{parentName:"p"},"GET /username")," endpoint:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"cargo make run\n")),(0,o.kt)("p",null,"You should see output that looks like the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"2023-09-08T02:14:03.388670Z  INFO simple: Started on port: 8000\n")),(0,o.kt)("p",null,"When you call ",(0,o.kt)("inlineCode",{parentName:"p"},"http://localhost:8000/username")," in your browser, you should see the following response:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "code": 200,\n  "username": "(anonymous)"\n}\n')),(0,o.kt)("h2",{id:"integration-testing"},"Integration Testing"),(0,o.kt)("p",null,"COMING SOON..."))}c.isMDXComponent=!0}}]);